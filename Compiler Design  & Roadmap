# AILang Self-Hosting Compiler Architecture
## Reference Document v1.2

### Overview

The self-hosting compiler is built in AILang to compile AILang source to native x86-64 ELF executables. It follows a **modular architecture** with clear separation between:

1. **Frontend** - Lexing and Parsing (COMPLETE)
2. **AST** - Abstract Syntax Tree manipulation (COMPLETE)
3. **Compile** - AST â†’ Instructions (one file per construct)
4. **CodeEmit** - Instructions â†’ Bytes (pure byte emission) (COMPLETE)
5. **Output** - Bytes â†’ ELF executable (COMPLETE)

### ğŸ‰ MILESTONE: First Light - December 26, 2025

Self-hosting compiler successfully compiled and executed:
```ailang
PrintNumber(Add(1, 2))  â†’  outputs "3"
```

Full pipeline working: Source â†’ Lex â†’ Parse â†’ AST â†’ Compile â†’ Emit â†’ ELF â†’ Native execution

---

### Design Principles

- **Separation of Concerns**: Compile modules call Emit functions, never emit bytes directly
- **One Construct = One File**: Easy to test, modify, maintain
- **No Monolithic Compiler**: Each module has Init/Process/Cleanup pattern
- **Clear Interfaces**: Modules communicate through well-defined function signatures
- **Architecture Separation**: CodeEmit/X86/ for x86-64, future CodeEmit/ARM64/, CodeEmit/RISCV/
- **No #ifdef Hell**: Backend swap at build time via imports, not conditionals

---

## Build Status

### Phase 1: Foundation âœ“ COMPLETE
- [x] Lexer - tokenization
- [x] Parser - AST generation
- [x] AST module - node types, creation, traversal
- [x] CEmitTypes - Reg enum, CC enum, Syscall numbers, fixup types
- [x] CEmitCore - buffer management, labels, fixups, strings

### Phase 2: Code Emission âœ“ COMPLETE
- [x] CEmitX86Reg - register moves, immediates
- [x] CEmitX86Mem - memory access, addressing modes
- [x] CEmitX86Stack - push/pop, prologue/epilogue
- [x] CEmitX86Arith - arithmetic operations
- [x] CEmitX86Logic - bitwise operations, shifts
- [x] CEmitX86Cmp - comparisons, SETcc
- [x] CEmitX86Jump - jumps, calls, returns
- [x] CEmitX86Sys - syscall, misc instructions

### Phase 3: Output âœ“ COMPLETE
- [x] CELFTypes - ELF64 constants, header structures
- [x] CELFBuilder - ELF executable generation
- [x] COutput - file I/O operations

### Phase 4: Compiler Modules (CURRENT)
- [x] CCompileMain - dispatcher, expression handling
- [x] CCompileArith - Add âœ“ (Subtract, Multiply, Divide pending)
- [x] CCompileIO - PrintNumber âœ“ (PrintMessage, PrintChar pending)
- [ ] CCompileExpr - variable loading, member access
- [ ] CCompileFunc - Function, SubRoutine, user call dispatch
- [ ] CCompileCompare - EqualTo, LessThan, GreaterThan, etc.
- [ ] CCompileLogic - And, Or, Not
- [ ] CCompileBitwise - BitwiseAnd, BitwiseOr, ShiftLeft, etc.

**Current Test**: `PrintNumber(Add(1, 2))` âœ“ PASSING

### Phase 5: Statements & Control Flow
- [ ] CCompileStmt - Assignment
- [ ] CCompileStmt - Return, Block
- [ ] CCompileStmt - IfCondition ThenBlock ElseBlock
- [ ] CCompileStmt - WhileLoop
- [ ] CCompileStmt - ForEvery
- [ ] Loop context (break/continue via ExitLoop/ContinueLoop)

### Phase 6: Memory & Pools
- [ ] CCompileMem - Allocate, Deallocate
- [ ] CCompileMem - StoreValue, Dereference
- [ ] CCompilePool - FixedPool access (R15-based)
- [ ] CCompilePool - DynamicPool
- [ ] CCompilePool - LinkagePool

### Phase 7: Strings & Collections
- [ ] CCompileString - StringLength, StringCompare, StringConcat
- [ ] CCompileString - StringToNumber, NumberToString
- [ ] CCompileArray - ArrayCreate, ArrayGet, ArraySet, ArrayLength
- [ ] CCompileXArray - XCreate, XPush, XPop, XGet, XSet, XSize

### Phase 8: System & Advanced
- [ ] CCompileSystem - Exit, SystemCall
- [ ] CCompileFunc - Full function definition with stack frames
- [ ] CCompileFunc - Parameter passing, local variables
- [ ] CCompileFunc - ReturnValue

### Phase 9: Console Application
- [ ] Wire up interactive console with new compiler
- [ ] load/compile/build commands
- [ ] tokens/ast/code dump commands
- [ ] REPL for expression testing

### Phase 10: Self-Hosting
- [ ] Compile the compiler with itself!
- [ ] Validate output matches Python-compiled version
- [ ] Remove Python bootstrap dependency

---

## Current Priority: Phase 4 Completion

### Immediate Next Steps

1. **CCompileArith** - Complete remaining operations:
   - Subtract
   - Multiply  
   - Divide
   - Modulo
   - Negate

2. **CCompileIO** - Complete remaining operations:
   - PrintMessage
   - PrintChar

3. **CCompileCompare** - All comparisons:
   - EqualTo, NotEqual
   - LessThan, LessEqual
   - GreaterThan, GreaterEqual

4. **CCompileLogic** - Boolean operations:
   - And, Or, Not

### Test Progression
```
âœ“ PrintNumber(Add(1, 2))                    # PASSING
  PrintNumber(Subtract(10, 3))              # Next
  PrintNumber(Multiply(4, 5))               # Next
  PrintMessage("Hello World\n")             # Next
  IfCondition GreaterThan(5, 3) ThenBlock: { PrintNumber(1) }  # Phase 5
```

---

## File Structure
```
Librarys/
â”œâ”€â”€ XArrays.ailang                    # Dynamic array library
â”‚
â””â”€â”€ Compiler/
    â”‚
    â”œâ”€â”€ Frontend/                     # âœ“ COMPLETE
    â”‚   â”œâ”€â”€ Lexer/                    # âœ“ 8 files
    â”‚   â”œâ”€â”€ Parser/                   # âœ“ 6 files
    â”‚   â””â”€â”€ AST/                      # âœ“ 5 files
    â”‚
    â”œâ”€â”€ Compile/                      # â— IN PROGRESS
    â”‚   â”œâ”€â”€ Library.CCompileMain.ailang       âœ“
    â”‚   â”œâ”€â”€ Library.CCompileTypes.ailang      
    â”‚   â””â”€â”€ Modules/
    â”‚       â”œâ”€â”€ Library.CCompileArith.ailang    â— Add working
    â”‚       â”œâ”€â”€ Library.CCompileIO.ailang       â— PrintNumber working
    â”‚       â”œâ”€â”€ Library.CCompileCompare.ailang  â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileLogic.ailang    â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileBitwise.ailang  â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileFunc.ailang     â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileStmt.ailang     â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileExpr.ailang     â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileMem.ailang      â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileString.ailang   â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileArray.ailang    â—‹ Stub
    â”‚       â”œâ”€â”€ Library.CCompileXArray.ailang   â—‹ Stub
    â”‚       â””â”€â”€ Library.CCompileSystem.ailang   â—‹ Stub
    â”‚
    â”œâ”€â”€ CodeEmit/                     # âœ“ COMPLETE
    â”‚   â”œâ”€â”€ Library.CEmitTypes.ailang     âœ“
    â”‚   â”œâ”€â”€ Library.CEmitCore.ailang      âœ“
    â”‚   â””â”€â”€ X86/                          # âœ“ 8 files
    â”‚
    â””â”€â”€ Output/                       # âœ“ COMPLETE
        â”œâ”€â”€ Library.CELFTypes.ailang      âœ“
        â”œâ”€â”€ Library.CELFBuilder.ailang    âœ“
        â””â”€â”€ Library.COutput.ailang        âœ“
```

Legend: âœ“ Complete | â— Partial | â—‹ Stub/TODO

---

## Multi-Architecture Strategy

Future backends will mirror X86 structure:
```
CodeEmit/
â”œâ”€â”€ X86/           # Current - x86-64
â”œâ”€â”€ ARM64/         # Future - aarch64 (Apple Silicon, AWS Graviton)
â””â”€â”€ RISCV/         # Future - rv64gc
```

Compile modules remain unchanged. Only CodeEmit imports change:
```ailang
// Current
LibraryImport.Compiler.CodeEmit.X86.CEmitX86Arith

// Future ARM64
LibraryImport.Compiler.CodeEmit.ARM64.CEmitARM64Arith
```

No conditionals in compile logic. Clean backend swap.

---

*Document Version: 1.2*
*Date: December 27, 2025*
*Status: FIRST LIGHT ACHIEVED - Phase 4 in progress*
