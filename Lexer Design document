# AILang Lexer Design Document — v1.0

## 1. Scope
This document specifies AILang's **Lexer (Lexical Analyzer)**: token types, tokenization rules, state management, and the interface between the lexer and parser. The lexer is the first stage of the compilation pipeline and converts raw source text into a stream of typed tokens.

---

## 2. Token Categories Overview

The Python implementation uses `auto()` for token values. For the self-hosting compiler, we assign explicit integer values organized by category:

| Category | Value Range | Description |
|----------|-------------|-------------|
| Special | 0-9 | EOF, NEWLINE, ERROR |
| Literals | 10-19 | IDENTIFIER, NUMBER, STRING |
| Comments | 20-29 | COMMENT, DOC_COMMENT, etc. |
| Delimiters | 30-49 | Braces, parens, punctuation |
| Symbol Operators | 50-69 | Raw symbols (+, *, etc.) |
| Two-Char Operators | 70-79 | ==, !=, >=, etc. |
| Control Flow | 100-129 | IfCondition, WhileLoop, etc. |
| Debug | 130-139 | Debug operations |
| Branching | 140-149 | Fork, Branch, Case |
| Pool Types | 150-159 | FixedPool, DynamicPool, etc. |
| Pool Operations | 160-179 | SubPool, Initialize, etc. |
| Math Operators | 200-209 | Add, Subtract, etc. |
| Comparison | 210-219 | GreaterThan, LessThan, etc. |
| Logical | 220-229 | And, Or, Not, etc. |
| Bitwise | 230-239 | BitwiseAnd, LeftShift, etc. |
| Functions | 250-269 | Function, Lambda, Input, etc. |
| Type Keywords | 270-289 | Integer, Text, Array, etc. |
| Low-Level Types | 290-309 | Byte, Word, Pointer, etc. |
| Boolean/Null | 310-319 | True, False, Null |
| Macros | 320-329 | Macro, RunMacro, etc. |
| Loop Model | 330-339 | LoopMain, LoopActor, etc. |
| Hash Operations | 340-349 | HashCreate, HashGet, etc. |
| Socket Operations | 350-359 | SocketCreate, SocketBind, etc. |
| System | 360-369 | Syscall, InlineAsm |
| Security | 370-379 | SecurityContext, WithSecurity |
| Memory Operations | 380-399 | Allocate, Dereference, etc. |
| File Operations | 400-449 | OpenFile, ReadFile, etc. |
| String Operations | 450-479 | StringLength, StringConcat, etc. |
| Units | 480-499 | Bytes, Kilobytes, Seconds, etc. |
| VM Operations | 500-549 | Virtual memory, paging |
| Hardware | 550-599 | Registers, ports, interrupts |

---

## 3. Complete Token Type Reference

### 3.1 Control Flow Keywords
```
RUNTASK, PRINTMESSAGE, RETURNVALUE
IFCONDITION, THENBLOCK, ELSEBLOCK, TRUEBLOCK, FALSEBLOCK
WHILELOOP, UNTILCONDITION, FOREVERY, IN
TRYBLOCK, CATCHERROR, FINALLYBLOCK
SENDMESSAGE, RECEIVEMESSAGE, EVERYINTERVAL
BREAKLOOP, HALTPROGRAM, CONTINUELOOP
```

### 3.2 Debug Operations
```
DEBUG, DEBUGASSERT, DEBUGTRACE, DEBUGBREAK
DEBUGMEMORY, DEBUGPERF, DEBUGINSPECT, DEBUGCONTROL
```

### 3.3 Branching Logic
```
FORK, BRANCH, CASE, DEFAULT, TRUEPATH, FALSEPATH
```

### 3.4 Pool Types
```
FIXEDPOOL, DYNAMICPOOL, TEMPORALPOOL, NEURALPOOL
KERNELPOOL, ACTORPOOL, SECURITYPOOL, CONSTRAINEDPOOL
FILEPOOL, LINKAGEPOOL
```

### 3.5 Pool Operations
```
SUBPOOL, INITIALIZE, CANCHANGE, CANBENULL, RANGE
MAXIMUMLENGTH, MINIMUMLENGTH, ELEMENTTYPE, WHERE
DIRECTION, INOUT
POOLRESIZE, POOLMOVE, POOLCOMPACT, POOLALLOCATE, POOLFREE
```

### 3.6 Math Operators (Named)
```
ADD, SUBTRACT, MULTIPLY, DIVIDE, POWER, MODULO
SQUAREROOT, ABSOLUTEVALUE
```

### 3.7 Comparison Operators (Named)
```
GREATERTHAN, LESSTHAN, GREATEREQUAL, LESSEQUAL
EQUALTO, NOTEQUAL
```

### 3.8 Logical Operators (Named)
```
AND, OR, NOT, XOR, IMPLIES
```

### 3.9 Bitwise Operators (Named)
```
BITWISEAND, BITWISEOR, BITWISEXOR, BITWISENOT
LEFTSHIFT, RIGHTSHIFT
```

### 3.10 Function/Declaration Keywords
```
FUNCTION, SUBROUTINE, LAMBDA, APPLY, COMBINATOR
INPUT, OUTPUT, BODY
CURRY, UNCURRY, COMPOSE
LIBRARYIMPORT
```

### 3.11 Type Keywords
```
INTEGER, FLOATINGPOINT, TEXT, BOOLEAN, ADDRESS
ARRAY, MAP, TUPLE, RECORD
OPTIONALTYPE, CONSTRAINEDTYPE, ANY, VOID
```

### 3.12 Low-Level Type Keywords
```
BYTE, WORD, DWORD, QWORD
UINT8, UINT16, UINT32, UINT64
INT8, INT16, INT32, INT64
POINTER
```

### 3.13 Boolean/Null Literals
```
TRUE, FALSE, NULL
AUTOMATIC, UNLIMITED
```

### 3.14 Macro Keywords
```
MACROBLOCK, MACRO, RUNMACRO, EXPANDMACRO
```

### 3.15 Loop Model Keywords
```
LOOPMAIN, LOOPACTOR, LOOPSTART, LOOPEND, LOOPSHADOW
LOOPSPAWN, LOOPYIELD, LOOPSEND, LOOPRECEIVE, LOOPREPLY
```

### 3.16 Hash Operations
```
HASHCREATE, HASHFUNCTION, HASHSET, HASHGET
```

### 3.17 Socket Operations
```
SOCKETCREATE, SOCKETBIND, SOCKETLISTEN, SOCKETACCEPT
SOCKETREAD, SOCKETWRITE, SOCKETCLOSE
SOCKETCONNECT, SOCKETSETOPTION
```

### 3.18 System/Hardware Keywords
```
HARDWARE, SYSCALL, INTERRUPT, REGISTER, MEMORY
PHYSICALADDRESS, VIRTUALADDRESS, FLAGS
INLINEASM
```

### 3.19 Security Keywords
```
SECURITYCONTEXT, WITHSECURITY
ALLOWEDOPERATIONS, DENIEDOPERATIONS
MEMORYLIMIT, CPUQUOTA, LEVEL
```

### 3.20 Memory Operations
```
POINTER, DEREFERENCE, ADDRESSOF, SIZEOF
ALLOCATE, DEALLOCATE
MEMORYCOPY, MEMORYSET, MEMORYCOMPARE
STOREVALUE
HARDWAREREGISTER, CONTROLREGISTER, SEGMENTREGISTER
FLAGSREGISTER, MODELSPECIFICREGISTER
```

### 3.21 Port I/O Operations
```
PORTREAD, PORTWRITE
PORTREADBYTE, PORTWRITEBYTE
PORTREADWORD, PORTWRITEWORD
PORTREADDWORD, PORTWRITEDWORD
```

### 3.22 File Operations
```
OPENFILE, CLOSEFILE, READFILE, WRITEFILE
SEEKFILE, GETFILESIZE, FILEEXISTS, DELETEFILE
COPYFILE, MOVEFILE, RENAMEFILE
FLUSHFILE, LOCKFILE, UNLOCKFILE
CREATEDIRECTORY, DELETEDIRECTORY, LISTDIRECTORY
DIRECTORYEXISTS, GETWORKINGDIRECTORY, SETWORKINGDIRECTORY
BUFFEREDREAD, BUFFEREDWRITE, SETBUFFERSIZE, FLUSHBUFFERS
```

### 3.23 String Operations
```
STRINGLENGTH, STRINGCONCAT, STRINGEQUALS, STRINGCOMPARE
STRINGSTARTSWITH, STRINGENDSWITH, STRINGCONTAINS
STRINGSLICE, STRINGFIND, STRINGREPLACE
STRINGTOLOWER, STRINGTOUPPER, STRINGTRIM
STRINGTONUMBER, NUMBERTOSTRING
READINPUT, READINPUTNUMBER, GETUSERCHOICE, READKEY
```

### 3.24 Array Operations
```
ARRAYCREATE, ARRAYGET, ARRAYSET, ARRAYLENGTH
ARRAYPUSH, ARRAYPOP, ARRAYSLICE
ARRAYDESTROY
```

### 3.25 Unit Keywords
```
BYTES, KILOBYTES, MEGABYTES, GIGABYTES
SECONDS, MILLISECONDS, MICROSECONDS
PERCENT
```

### 3.26 Mathematical Constants
```
CONSTANT, PI, E, PHI
```

### 3.27 Virtual Memory Operations
```
PAGETABLE, PAGEENTRY, MAPPAGE, UNMAPPAGE
GETPHYSICAL, GETVIRTUAL, SETPAGEFLAGS
PRESENT, WRITABLE, USERMODE, EXECUTABLE
GLOBAL, DIRTY, ACCESSED
CACHED, UNCACHED, WRITECOMBINING, WRITETHROUGH, WRITEBACK
L1CACHE, L2CACHE, L3CACHE
PAGESIZE4KB, PAGESIZE2MB, PAGESIZE1GB
INVALIDATE, FLUSH, FLUSHALL, FLUSHGLOBAL
```

### 3.28 Symbol Operators (Raw)
```
PLUS_SIGN (+), STAR_SIGN (*), SLASH_SIGN (/)
PERCENT_SIGN (%), CARET_SIGN (^)
GREATER_SIGN (>), LESS_SIGN (<)
BANG_SIGN (!), AMPERSAND_SIGN (&)
PIPE_SIGN (|), TILDE_SIGN (~)
```

### 3.29 Two-Character Operators
```
EQUALTO (==) → value "EqualTo"
NOTEQUAL (!=) → value "NotEqual"
GREATEREQUAL (>=) → value "GreaterEqual"
LESSEQUAL (<=) → value "LessEqual"
AND_AND (&&) → value "And"
PIPE_PIPE (||) → value "Or"
LESS_LESS (<<) → value "LeftShift"
GREATER_GREATER (>>) → value "RightShift"
ARROW (->) → value "->"
```

### 3.30 Delimiters
```
DOT (.), LBRACE ({), RBRACE (})
LPAREN ((), RPAREN ())
LBRACKET ([), RBRACKET (])
COMMA (,), COLON (:), SEMICOLON (;)
DASH (-), EQUALS (=), ARROW (->)
```

### 3.31 Literals and Special
```
IDENTIFIER, NUMBER, STRING
COMMENT, DOC_COMMENT, COM_COMMENT, TAG_COMMENT
EOF, NEWLINE, ERROR
```

---

## 4. Keyword to Token Mapping

The complete keyword mapping from `keywords.py`:

```python
{
    # Control Flow
    'Body': BODY,
    'RunTask': RUNTASK,
    'PrintMessage': PRINTMESSAGE,
    'ReturnValue': RETURNVALUE,
    'IfCondition': IFCONDITION,
    'ThenBlock': THENBLOCK,
    'ElseBlock': ELSEBLOCK,
    'TrueBlock': TRUEBLOCK,
    'FalseBlock': FALSEBLOCK,
    'WhileLoop': WHILELOOP,
    'UntilCondition': UNTILCONDITION,
    'ForEvery': FOREVERY,
    'in': IN,
    'TryBlock': TRYBLOCK,
    'CatchError': CATCHERROR,
    'FinallyBlock': FINALLYBLOCK,
    'SendMessage': SENDMESSAGE,
    'ReceiveMessage': RECEIVEMESSAGE,
    'EveryInterval': EVERYINTERVAL,
    'BreakLoop': BREAKLOOP,
    'HaltProgram': HALTPROGRAM,
    'ContinueLoop': CONTINUELOOP,
    
    # Branching
    'Fork': FORK,
    'Branch': BRANCH,
    'Case': CASE,
    'Default': DEFAULT,
    'TruePath': TRUEPATH,
    'FalsePath': FALSEPATH,
    
    # Debug
    'Debug': DEBUG,
    'DebugAssert': DEBUGASSERT,
    'DebugTrace': DEBUGTRACE,
    'DebugBreak': DEBUGBREAK,
    'DebugMemory': DEBUGMEMORY,
    'DebugPerf': DEBUGPERF,
    'DebugInspect': DEBUGINSPECT,
    'DebugControl': DEBUGCONTROL,
    
    # Pool Types
    'FixedPool': FIXEDPOOL,
    'DynamicPool': DYNAMICPOOL,
    'TemporalPool': TEMPORALPOOL,
    'NeuralPool': NEURALPOOL,
    'KernelPool': KERNELPOOL,
    'ActorPool': ACTORPOOL,
    'SecurityPool': SECURITYPOOL,
    'ConstrainedPool': CONSTRAINEDPOOL,
    'FilePool': FILEPOOL,
    'LinkagePool': LINKAGEPOOL,
    
    # Pool Operations
    'SubPool': SUBPOOL,
    'Initialize': INITIALIZE,
    'CanChange': CANCHANGE,
    'CanBeNull': CANBENULL,
    'Range': RANGE,
    'MaximumLength': MAXIMUMLENGTH,
    'MinimumLength': MINIMUMLENGTH,
    'ElementType': ELEMENTTYPE,
    'Where': WHERE,
    'Direction': DIRECTION,
    'InOut': INOUT,
    'PoolResize': POOLRESIZE,
    'PoolMove': POOLMOVE,
    'PoolCompact': POOLCOMPACT,
    'PoolAllocate': POOLALLOCATE,
    'PoolFree': POOLFREE,
    
    # Math
    'Add': ADD,
    'Subtract': SUBTRACT,
    'Multiply': MULTIPLY,
    'Divide': DIVIDE,
    'Power': POWER,
    'Modulo': MODULO,
    'SquareRoot': SQUAREROOT,
    'AbsoluteValue': ABSOLUTEVALUE,
    
    # Comparison
    'GreaterThan': GREATERTHAN,
    'LessThan': LESSTHAN,
    'GreaterEqual': GREATEREQUAL,
    'LessEqual': LESSEQUAL,
    'EqualTo': EQUALTO,
    'NotEqual': NOTEQUAL,
    
    # Logical
    'And': AND,
    'Or': OR,
    'Not': NOT,
    'Xor': XOR,
    'Implies': IMPLIES,
    
    # Bitwise
    'BitwiseAnd': BITWISEAND,
    'BitwiseOr': BITWISEOR,
    'BitwiseXor': BITWISEXOR,
    'BitwiseNot': BITWISENOT,
    'LeftShift': LEFTSHIFT,
    'RightShift': RIGHTSHIFT,
    
    # Functions
    'Function': FUNCTION,
    'SubRoutine': SUBROUTINE,
    'Lambda': LAMBDA,
    'Apply': APPLY,
    'Combinator': COMBINATOR,
    'Input': INPUT,
    'Output': OUTPUT,
    'Curry': CURRY,
    'Uncurry': UNCURRY,
    'Compose': COMPOSE,
    'LibraryImport': LIBRARYIMPORT,
    
    # Types
    'Integer': INTEGER,
    'FloatingPoint': FLOATINGPOINT,
    'Text': TEXT,
    'Boolean': BOOLEAN,
    'Address': ADDRESS,
    'Array': ARRAY,
    'Map': MAP,
    'Tuple': TUPLE,
    'Record': RECORD,
    'OptionalType': OPTIONALTYPE,
    'ConstrainedType': CONSTRAINEDTYPE,
    'Any': ANY,
    'Void': VOID,
    
    # Low-Level Types
    'Byte': BYTE,
    'Word': WORD,
    'DWord': DWORD,
    'QWord': QWORD,
    'UInt8': UINT8,
    'UInt16': UINT16,
    'UInt32': UINT32,
    'UInt64': UINT64,
    'Int8': INT8,
    'Int16': INT16,
    'Int32': INT32,
    'Int64': INT64,
    'Pointer': POINTER,
    
    # Literals
    'True': TRUE,
    'False': FALSE,
    'Null': NULL,
    'Automatic': AUTOMATIC,
    'Unlimited': UNLIMITED,
    
    # Macros
    'MacroBlock': MACROBLOCK,
    'Macro': MACRO,
    'RunMacro': RUNMACRO,
    'ExpandMacro': EXPANDMACRO,
    
    # Loop Model
    'LoopMain': LOOPMAIN,
    'LoopActor': LOOPACTOR,
    'LoopStart': LOOPSTART,
    'LoopEnd': LOOPEND,
    'LoopShadow': LOOPSHADOW,
    'LoopSpawn': LOOPSPAWN,
    'LoopYield': LOOPYIELD,
    'LoopSend': LOOPSEND,
    'LoopReceive': LOOPRECEIVE,
    'LoopReply': LOOPREPLY,
    
    # Hash
    'HashCreate': HASHCREATE,
    'HashFunction': HASHFUNCTION,
    'HashSet': HASHSET,
    'HashGet': HASHGET,
    
    # Socket
    'SocketCreate': SOCKETCREATE,
    'SocketBind': SOCKETBIND,
    'SocketListen': SOCKETLISTEN,
    'SocketAccept': SOCKETACCEPT,
    'SocketRead': SOCKETREAD,
    'SocketWrite': SOCKETWRITE,
    'SocketClose': SOCKETCLOSE,
    'SocketConnect': SOCKETCONNECT,
    'SocketSetOption': SOCKETSETOPTION,
    
    # Security
    'SecurityContext': SECURITYCONTEXT,
    'WithSecurity': WITHSECURITY,
    'AllowedOperations': ALLOWEDOPERATIONS,
    'DeniedOperations': DENIEDOPERATIONS,
    'MemoryLimit': MEMORYLIMIT,
    'CPUQuota': CPUQUOTA,
    'Level': LEVEL,
    
    # System
    'Hardware': HARDWARE,
    'SystemCall': SYSCALL,
    'Interrupt': INTERRUPT,
    'Register': REGISTER,
    'Memory': MEMORY,
    'PhysicalAddress': PHYSICALADDRESS,
    'VirtualAddress': VIRTUALADDRESS,
    'Flags': FLAGS,
    
    # Memory Operations
    'Pointer': POINTER,
    'Dereference': DEREFERENCE,
    'AddressOf': ADDRESSOF,
    'SizeOf': SIZEOF,
    'Allocate': ALLOCATE,
    'Deallocate': DEALLOCATE,
    'MemoryCopy': MEMORYCOPY,
    'MemorySet': MEMORYSET,
    'MemoryCompare': MEMORYCOMPARE,
    'StoreValue': STOREVALUE,
    
    # Units
    'Bytes': BYTES,
    'Kilobytes': KILOBYTES,
    'Megabytes': MEGABYTES,
    'Gigabytes': GIGABYTES,
    'Seconds': SECONDS,
    'Milliseconds': MILLISECONDS,
    'Microseconds': MICROSECONDS,
    'Percent': PERCENT,
    
    # Constants
    'Constant': CONSTANT,
    'PI': PI,
    'E': E,
    'PHI': PHI,
    
    # ... plus many more for file I/O, strings, VM, etc.
}
```

---

## 5. Number Literal Formats

### 5.1 Decimal Integers
```
42
1000000
1_000_000    (underscores allowed as separators)
```

### 5.2 Hexadecimal
```
0xFF
0x1A2B3C
0xDEAD_BEEF  (underscores allowed)
```

### 5.3 Binary
```
0b1010
0b1111_0000  (underscores allowed)
```

### 5.4 Floating Point
```
3.14159
0.5
100.0
```

### 5.5 Scientific Notation
```
1e10
2.5e-3
6.022E23
1.0e+5
```

### 5.6 Negative Numbers
```
-42
-3.14
-0xFF
```

---

## 6. String Literal Format

### 6.1 Basic Strings
```
"Hello, World!"
""              (empty string)
```

### 6.2 Escape Sequences
| Escape | Result |
|--------|--------|
| `\n` | Newline (0x0A) |
| `\t` | Tab (0x09) |
| `\r` | Carriage return (0x0D) |
| `\\` | Backslash |
| `\"` | Double quote |
| `\0` | Null byte |

---

## 7. Comment Formats

### 7.1 Line Comments
```ailang
// Regular comment - ignored by compiler
```

### 7.2 Documentation Comments
```ailang
//DOC: This function calculates the sum
//DOC: of two integers and returns the result
```

### 7.3 Component Comments
```ailang
//COM: Component marker for tooling
```

### 7.4 Tag Comments
```ailang
//TAG: version=1.0, author=Sean
```

---

## 8. Identifier Rules

### 8.1 Simple Identifiers
- Start with: letter (a-z, A-Z) or underscore (_)
- Continue with: letters, digits (0-9), or underscores
- Case sensitive: `myVar` ≠ `MyVar`

```ailang
x
myVariable
_private
CamelCase
value123
```

### 8.2 Dotted Identifiers
Module paths use dots:
```ailang
XArray.XCreate
Library.Module.Function
Hardware.Syscall.Write
```

### 8.3 Tilde Suffix
Special identifiers can end with tilde:
```ailang
cleanup~
destructor~
```

### 8.4 Allowed Short Identifiers
Single-letter identifiers allowed: `i`, `j`, `k`, `n`, `x`, `y`, `z`, etc.

---

## 9. Lexer Module Structure

### 9.1 Module Dependencies
```
CLexerTypes.ailang      ← Token constants, state pools, ASCII constants
       ↓
CLexerKeywords.ailang   ← Keyword hash table, lookup functions
       ↓
CLexerCore.ailang       ← Init, character access, token creation
       ↓
CLexerStrings.ailang    ← String and comment lexing
CLexerNumbers.ailang    ← Number literal lexing
CLexerOperators.ailang  ← Operator and delimiter lexing
CLexerIdentifiers.ailang ← Identifier and keyword lexing
       ↓
CLexerMain.ailang       ← Main tokenization loop
```

### 9.2 Public API
```ailang
Lex_Init(source: Address, len: Integer) -> Integer
Lex_Tokenize() -> Integer  // Returns count or -1
Lex_GetToken(index: Integer) -> Address
Lex_GetTokenCount() -> Integer
Lex_GetType(index: Integer) -> Integer
Lex_GetVal(index: Integer) -> Address
Lex_GetLine(index: Integer) -> Integer
Lex_Free()
```

---

## 10. Tokenization Algorithm

### 10.1 Main Loop
```
1. Skip whitespace (spaces, tabs, carriage returns)
2. Record current position (line, col)
3. Examine current character:
   - EOF (0) → emit EOF token, done
   - Newline → emit NEWLINE, advance
   - '/' followed by '/' → tokenize comment
   - '"' → tokenize string
   - Digit or '-' followed by digit → tokenize number
   - Letter or '_' → tokenize identifier/keyword
   - Otherwise → try operators/delimiters
4. Repeat until EOF
```

### 10.2 Two-Character Operator Precedence
Always check two-character operators before single-character:
```
"==" before "="
">=" before ">"
"->" before "-"
"&&" before "&"
etc.
```

---

## 11. Reference: Python Source Files

The authoritative source for token definitions:
- `ailang_parser/lexer_modules/token_type.py` - TokenType enum
- `ailang_parser/lexer_modules/keywords.py` - Keyword mappings
- `ailang_parser/lexer_modules/lexer_class.py` - Lexer implementation

---

## 12. Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2025-01 | Initial specification for self-hosting compiler |
