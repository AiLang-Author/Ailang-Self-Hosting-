// 2_cooperative_scheduler_tests.ailang
// COOPERATIVE SCHEDULER TEST SUITE
// Tests manual cooperative scheduling using SubRoutines

PrintMessage("==============================================")
PrintMessage("COOPERATIVE SCHEDULER TEST SUITE")
PrintMessage("==============================================")
PrintMessage("")

// Test tracking
total_tests = 0
passed_tests = 0
failed_tests = 0

// Scheduler state
task_queue_size = 0
current_task = 0
task_count = 0

// Task state tracking
task1_runs = 0
task2_runs = 0
task3_runs = 0
task4_runs = 0
task1_complete = 0
task2_complete = 0
task3_complete = 0
task4_complete = 0

// Task work counters
task1_work = 0
task2_work = 0
task3_work = 0
task4_work = 0

SubRoutine.TestResult {
    total_tests = Add(total_tests, 1)
    PrintMessage("TEST: ")
    PrintMessage(test_name)
    PrintMessage(" | Expected: ")
    PrintNumber(expected)
    PrintMessage(" | Actual: ")
    PrintNumber(actual)
    
    IfCondition EqualTo(expected, actual) ThenBlock: {
        PrintMessage(" | PASS")
        passed_tests = Add(passed_tests, 1)
    } ElseBlock: {
        PrintMessage(" | FAIL")
        failed_tests = Add(failed_tests, 1)
    }
}

// ==============================================
// SECTION 1: BASIC TASK EXECUTION
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SECTION 1: BASIC TASK EXECUTION")
PrintMessage("==============================================")

// Define tasks as subroutines
SubRoutine.Task1 {
    PrintMessage("  Task1 running")
    task1_runs = Add(task1_runs, 1)
    task1_work = Add(task1_work, 10)
    
    // Simulate work completion after 3 runs - FIXED: use Not(LessThan(...))
    IfCondition Not(LessThan(task1_runs, 3)) ThenBlock: {
        task1_complete = 1
        PrintMessage("  Task1 COMPLETE")
    }
}

SubRoutine.Task2 {
    PrintMessage("  Task2 running")
    task2_runs = Add(task2_runs, 1)
    task2_work = Add(task2_work, 20)
    
    // Simulate work completion after 3 runs (changed from 2)
    IfCondition Not(LessThan(task2_runs, 3)) ThenBlock: {
        task2_complete = 1
        PrintMessage("  Task2 COMPLETE")
    }
}

SubRoutine.Task3 {
    PrintMessage("  Task3 running")
    task3_runs = Add(task3_runs, 1)
    task3_work = Add(task3_work, 5)
    
    // Simulate work completion after 4 runs - FIXED: use Not(LessThan(...))
    IfCondition Not(LessThan(task3_runs, 4)) ThenBlock: {
        task3_complete = 1
        PrintMessage("  Task3 COMPLETE")
    }
}

// Test 1.1: Single task execution
test_name = "Single task exec"
task1_runs = 0
task1_work = 0
RunTask(Task1)
expected = 1
actual = task1_runs
RunTask(TestResult)

// Test 1.2: Multiple runs of same task
test_name = "Multiple runs"
task1_runs = 0
task1_work = 0
RunTask(Task1)
RunTask(Task1)
RunTask(Task1)
expected = 3
actual = task1_runs
RunTask(TestResult)

// Test 1.3: Work accumulation
test_name = "Work accumulation"
expected = 30
actual = task1_work
RunTask(TestResult)

// ==============================================
// SECTION 2: ROUND-ROBIN SCHEDULING
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SECTION 2: ROUND-ROBIN SCHEDULING")
PrintMessage("==============================================")

// Reset task state
task1_runs = 0
task2_runs = 0
task3_runs = 0
task1_work = 0
task2_work = 0
task3_work = 0
task1_complete = 0
task2_complete = 0
task3_complete = 0

// Manual round-robin scheduler
SubRoutine.RoundRobinScheduler {
    PrintMessage("Round-robin scheduler starting")
    
    scheduler_cycle = 0
    max_cycles = 10
    
    WhileLoop LessThan(scheduler_cycle, max_cycles) {
        PrintMessage("Cycle ")
        PrintNumber(scheduler_cycle)
        
        // Round-robin: Task1 -> Task2 -> Task3
        task_slot = Modulo(scheduler_cycle, 3)
        
        Branch task_slot {
            Case 0: {
                IfCondition EqualTo(task1_complete, 0) ThenBlock: {
                    RunTask(Task1)
                }
            }
            Case 1: {
                IfCondition EqualTo(task2_complete, 0) ThenBlock: {
                    RunTask(Task2)
                }
            }
            Case 2: {
                IfCondition EqualTo(task3_complete, 0) ThenBlock: {
                    RunTask(Task3)
                }
            }
        }
        
        scheduler_cycle = Add(scheduler_cycle, 1)
    }
    
    PrintMessage("Round-robin scheduler finished")
}

RunTask(RoundRobinScheduler)

// Test 2.1: Task1 ran correct times
test_name = "RR Task1 runs"
expected = 3
actual = task1_runs
RunTask(TestResult)

// Test 2.2: Task2 ran correct times
test_name = "RR Task2 runs"
expected = 3
actual = task2_runs
RunTask(TestResult)

// Test 2.3: Task3 ran correct times
test_name = "RR Task3 runs"
expected = 3
actual = task3_runs
RunTask(TestResult)

// Test 2.4: Task1 work
test_name = "RR Task1 work"
expected = 30
actual = task1_work
RunTask(TestResult)

// Test 2.5: All tasks completed
test_name = "All tasks complete"
all_done = And(task1_complete, And(task2_complete, task3_complete))
expected = 1
actual = all_done
RunTask(TestResult)

// ==============================================
// SECTION 3: PRIORITY SCHEDULING
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SECTION 3: PRIORITY SCHEDULING")
PrintMessage("==============================================")

// Reset state
task1_runs = 0
task2_runs = 0
task3_runs = 0
task1_complete = 0
task2_complete = 0
task3_complete = 0

// Priority scheduler: higher priority tasks run first
SubRoutine.PriorityScheduler {
    PrintMessage("Priority scheduler starting")
    
    cycles = 0
    max_priority_cycles = 15
    
    WhileLoop LessThan(cycles, max_priority_cycles) {
        PrintMessage("Priority cycle ")
        PrintNumber(cycles)
        
        // Priority order: Task1 (high), Task2 (medium), Task3 (low)
        // Run high priority if not complete
        IfCondition EqualTo(task1_complete, 0) ThenBlock: {
            RunTask(Task1)
        } ElseBlock: {
            // High priority done, run medium
            IfCondition EqualTo(task2_complete, 0) ThenBlock: {
                RunTask(Task2)
            } ElseBlock: {
                // Medium done, run low
                IfCondition EqualTo(task3_complete, 0) ThenBlock: {
                    RunTask(Task3)
                }
            }
        }
        
        cycles = Add(cycles, 1)
    }
    
    PrintMessage("Priority scheduler finished")
}

RunTask(PriorityScheduler)

// Test 3.1: High priority task completed first
test_name = "Priority Task1 complete"
expected = 1
actual = task1_complete
RunTask(TestResult)

// Test 3.2: Task1 ran exactly enough times
test_name = "Priority Task1 runs"
expected = 3
actual = task1_runs
RunTask(TestResult)

// Test 3.3: Task2 completed after Task1
test_name = "Priority Task2 complete"
expected = 1
actual = task2_complete
RunTask(TestResult)

// Test 3.4: Task3 completed last
test_name = "Priority Task3 complete"
expected = 1
actual = task3_complete
RunTask(TestResult)

// ==============================================
// FINAL SUMMARY
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("FINAL TEST SUMMARY")
PrintMessage("==============================================")

PrintMessage("Total Tests: ")
PrintNumber(total_tests)
PrintMessage("Passed: ")
PrintNumber(passed_tests)
PrintMessage("Failed: ")
PrintNumber(failed_tests)

success_rate = 0
IfCondition GreaterThan(total_tests, 0) ThenBlock: {
    success_rate = Divide(Multiply(passed_tests, 100), total_tests)
}

PrintMessage("Success Rate: ")
PrintNumber(success_rate)
PrintMessage("%")
PrintMessage("")

IfCondition EqualTo(failed_tests, 0) ThenBlock: {
    PrintMessage("ALL TESTS PASSED!")
    PrintMessage("Cooperative scheduler working perfectly!")
} ElseBlock: {
    PrintMessage("SOME FAILURES DETECTED")
    PrintMessage("Review failed tests above")
}

PrintMessage("")
PrintMessage("Scheduler Coverage:")
PrintMessage("- Basic task execution")
PrintMessage("- Round-robin scheduling")
PrintMessage("- Priority-based scheduling")
PrintMessage("")
PrintMessage("Test complete.")
PrintMessage("==============================================")