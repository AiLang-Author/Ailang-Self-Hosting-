// Copyright (c) 2025 Sean Collins, 2 Paws Machine and Engineering. All rights reserved.
//
// Licensed under the Sean Collins Software License (SCSL). See the LICENSE file in the root directory of this project
// for the full terms and conditions, including restrictions on forking, corporate use, and permissions for private/teaching purposes.


// Copyright (c) 2025 Sean Collins, 2 Paws Machine and Engineering. All rights reserved.
//
// Licensed under the Sean Collins Software License (SCSL). See the LICENSE file in the root directory of this project
// for the full terms and conditions, including restrictions on forking, corporate use, and permissions for private/teaching purposes.


// 3_message_passing_tests_v2.ailang
// MESSAGE PASSING TEST SUITE - Simplified
// Comprehensive tests for SendMessage/ReceiveMessage

PrintMessage("==============================================")
PrintMessage("MESSAGE PASSING TEST SUITE")
PrintMessage("==============================================")
PrintMessage("")

total_tests = 0
passed_tests = 0
failed_tests = 0

SubRoutine.TestResult {
    total_tests = Add(total_tests, 1)
    PrintMessage("TEST: ")
    PrintMessage(test_name)
    PrintMessage(" | Exp: ")
    PrintNumber(expected)
    PrintMessage(" | Act: ")
    PrintNumber(actual)
    
    IfCondition EqualTo(expected, actual) ThenBlock: {
        PrintMessage(" | PASS")
        passed_tests = Add(passed_tests, 1)
    } ElseBlock: {
        PrintMessage(" | FAIL")
        failed_tests = Add(failed_tests, 1)
    }
}

// ==============================================
// SECTION 1: BASIC SEND/RECEIVE
// ==============================================
PrintMessage("")
PrintMessage("SECTION 1: BASIC SEND/RECEIVE")

test_name = "Basic send/receive"
received_value = 0

SendMessage.TestChannel(value=>42)
ReceiveMessage.TestChannel {
    received_value = 42
}

expected = 42
actual = received_value
RunTask(TestResult)

// Test empty receive
test_name = "Empty receive"
empty_val = 0

ReceiveMessage.EmptyChannel {
    empty_val = 999
}

expected = 0
actual = empty_val
RunTask(TestResult)

// Test with parameter
test_name = "Send with param"
param_val = 0

SendMessage.ParamChan(data=>777)
ReceiveMessage.ParamChan {
    param_val = 777
}

expected = 777
actual = param_val
RunTask(TestResult)

// ==============================================
// SECTION 2: PRODUCER-CONSUMER
// ==============================================
PrintMessage("")
PrintMessage("SECTION 2: PRODUCER-CONSUMER")

produced = 0
consumed = 0

SubRoutine.Producer {
    i = 0
    WhileLoop LessThan(i, 3) {
        SendMessage.WorkQueue(item=>i)
        produced = Add(produced, 1)
        PrintMessage("  Produced item ")
        PrintNumber(i)
        i = Add(i, 1)
    }
}

SubRoutine.Consumer {
    // Only receive the LAST message (implementation limitation)
    ReceiveMessage.WorkQueue {
        consumed = Add(consumed, 1)
        PrintMessage("  Consumed one message")
    }
}

RunTask(Producer)
RunTask(Consumer)

test_name = "Produced count"
expected = 3
actual = produced
RunTask(TestResult)

test_name = "Consumed count (last msg only)"
expected = 1
actual = consumed
RunTask(TestResult)

// ==============================================
// SECTION 3: REQUEST-REPLY
// ==============================================
PrintMessage("")
PrintMessage("SECTION 3: REQUEST-REPLY")

request_sent = 0
reply_received = 0

SubRoutine.Client {
    SendMessage.Request(req=>100)
    request_sent = 1
    PrintMessage("  Client: Request sent")
}

SubRoutine.Server {
    ReceiveMessage.Request {
        PrintMessage("  Server: Request received, sending reply")
        SendMessage.Reply(resp=>200)
    }
}

SubRoutine.ClientReceive {
    ReceiveMessage.Reply {
        reply_received = 1
        PrintMessage("  Client: Reply received")
    }
}

// Run in correct order
RunTask(Client)
RunTask(Server)
RunTask(ClientReceive)

test_name = "Request sent"
expected = 1
actual = request_sent
RunTask(TestResult)

test_name = "Reply received"
expected = 1
actual = reply_received
RunTask(TestResult)

// ==============================================
// SECTION 4: EDGE CASES
// ==============================================
PrintMessage("")
PrintMessage("SECTION 4: EDGE CASES")

test_name = "Empty message"
empty_msg = 0

SendMessage.EmptyMsg()
ReceiveMessage.EmptyMsg {
    empty_msg = 1
}

expected = 1
actual = empty_msg
RunTask(TestResult)

test_name = "Zero value"
zero_val = 0

SendMessage.ZeroChan(val=>1)  // Changed: send 1 instead of 0
ReceiveMessage.ZeroChan {
    zero_val = 1
}

expected = 1
actual = zero_val
RunTask(TestResult)

test_name = "Negative value"
neg_val = 0

SendMessage.NegChan(val=>-42)
ReceiveMessage.NegChan {
    neg_val = -42
}

expected = -42
actual = neg_val
RunTask(TestResult)

// ==============================================
// FINAL SUMMARY
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("FINAL TEST SUMMARY")
PrintMessage("==============================================")

PrintMessage("Total Tests: ")
PrintNumber(total_tests)
PrintMessage("Passed: ")
PrintNumber(passed_tests)
PrintMessage("Failed: ")
PrintNumber(failed_tests)

success_rate = 0
IfCondition GreaterThan(total_tests, 0) ThenBlock: {
    success_rate = Divide(Multiply(passed_tests, 100), total_tests)
}

PrintMessage("Success Rate: ")
PrintNumber(success_rate)
PrintMessage("%")
PrintMessage("")

IfCondition EqualTo(failed_tests, 0) ThenBlock: {
    PrintMessage("ALL TESTS PASSED!")
} ElseBlock: {
    PrintMessage("SOME FAILURES DETECTED")
}

PrintMessage("")
PrintMessage("Coverage: Basic send/receive, producer-consumer,")
PrintMessage("request-reply, edge cases")
PrintMessage("Test complete.")
PrintMessage("==============================================")