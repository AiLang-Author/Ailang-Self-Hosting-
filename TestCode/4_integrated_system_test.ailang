// Copyright (c) 2025 Sean Collins, 2 Paws Machine and Engineering. All rights reserved.
//
// Licensed under the Sean Collins Software License (SCSL). See the LICENSE file in the root directory of this project
// for the full terms and conditions, including restrictions on forking, corporate use, and permissions for private/teaching purposes.


// Copyright (c) 2025 Sean Collins, 2 Paws Machine and Engineering. All rights reserved.
//
// Licensed under the Sean Collins Software License (SCSL). See the LICENSE file in the root directory of this project
// for the full terms and conditions, including restrictions on forking, corporate use, and permissions for private/teaching purposes.


// 4_integrated_system_test.ailang
// INTEGRATED SYSTEM TEST
// Combines Flow Control + Scheduler + Message Passing

PrintMessage("==============================================")
PrintMessage("INTEGRATED SYSTEM TEST SUITE")
PrintMessage("Testing Flow Control + Scheduler + Messages")
PrintMessage("==============================================")
PrintMessage("")

// Test tracking
total_tests = 0
passed_tests = 0
failed_tests = 0

SubRoutine.TestResult {
    total_tests = Add(total_tests, 1)
    PrintMessage("TEST: ")
    PrintMessage(test_name)
    PrintMessage(" | Expected: ")
    PrintNumber(expected)
    PrintMessage(" | Actual: ")
    PrintNumber(actual)
    
    IfCondition EqualTo(expected, actual) ThenBlock: {
        PrintMessage(" | PASS")
        passed_tests = Add(passed_tests, 1)
    } ElseBlock: {
        PrintMessage(" | FAIL")
        failed_tests = Add(failed_tests, 1)
    }
}

// ==============================================
// SCENARIO 1: TASK SCHEDULER WITH MESSAGES
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 1: TASK SCHEDULER WITH MESSAGES")
PrintMessage("==============================================")

// Scheduler state
task1_status = 0  // 0=pending, 1=running, 2=complete
task2_status = 0
task3_status = 0

// Task results
task1_result = 0
task2_result = 0
task3_result = 0

SubRoutine.WorkerTask1 {
    PrintMessage("  Task1: Checking for start message")
    ReceiveMessage.Task1Start {
        PrintMessage("  Task1: Working")
        task1_status = 2
        task1_result = 100
        
        SendMessage.Task1Done(result=>task1_result)
        PrintMessage("  Task1: Done, sent completion")
    }
}

SubRoutine.WorkerTask2 {
    PrintMessage("  Task2: Checking for start message")
    ReceiveMessage.Task2Start {
        PrintMessage("  Task2: Working")
        task2_status = 2
        task2_result = 200
        
        SendMessage.Task2Done(result=>task2_result)
        PrintMessage("  Task2: Done, sent completion")
    }
}

SubRoutine.WorkerTask3 {
    PrintMessage("  Task3: Checking for start message")
    ReceiveMessage.Task3Start {
        PrintMessage("  Task3: Working")
        task3_status = 2
        task3_result = 300
        
        SendMessage.Task3Done(result=>task3_result)
        PrintMessage("  Task3: Done, sent completion")
    }
}

SubRoutine.Coordinator {
    PrintMessage("  Coordinator: Sending start messages")
    SendMessage.Task1Start(cmd=>1)
    SendMessage.Task2Start(cmd=>1)
    SendMessage.Task3Start(cmd=>1)
    PrintMessage("  Coordinator: All start messages sent")
}

SubRoutine.ResultCollector {
    PrintMessage("  Collector: Checking for results")
    
    ReceiveMessage.Task1Done {
        PrintMessage("  Collector: Got Task1 result")
    }
    
    ReceiveMessage.Task2Done {
        PrintMessage("  Collector: Got Task2 result")
    }
    
    ReceiveMessage.Task3Done {
        PrintMessage("  Collector: Got Task3 result")
    }
}

// Run the system in correct order
PrintMessage("Starting distributed task system...")
RunTask(Coordinator)
RunTask(WorkerTask1)
RunTask(WorkerTask2)
RunTask(WorkerTask3)
RunTask(ResultCollector)

// Test 1.1: All tasks completed
test_name = "All tasks complete"
all_complete = And(EqualTo(task1_status, 2), And(EqualTo(task2_status, 2), EqualTo(task3_status, 2)))
expected = 1
actual = all_complete
RunTask(TestResult)

// Test 1.2: Results correct
test_name = "Results sum"
results_sum = Add(task1_result, Add(task2_result, task3_result))
expected = 600
actual = results_sum
RunTask(TestResult)

// ==============================================
// SCENARIO 2: CONDITIONAL ROUTING WITH BRANCHES
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 2: CONDITIONAL ROUTING WITH BRANCHES")
PrintMessage("==============================================")

// Message router - only last message per channel stored
route_a_count = 0
route_b_count = 0
route_c_count = 0

SubRoutine.MessageRouter {
    PrintMessage("  Router: Routing based on value")
    
    // Route a single value
    test_value = 7
    route_decision = Modulo(test_value, 3)
    
    Branch route_decision {
        Case 0: {
            SendMessage.RouteA(msg=>test_value)
            PrintMessage("  Router: Sent to Route A")
        }
        Case 1: {
            SendMessage.RouteB(msg=>test_value)
            PrintMessage("  Router: Sent to Route B")
        }
        Case 2: {
            SendMessage.RouteC(msg=>test_value)
            PrintMessage("  Router: Sent to Route C")
        }
    }
}

SubRoutine.RouteAHandler {
    PrintMessage("  Route A: Checking")
    ReceiveMessage.RouteA {
        route_a_count = Add(route_a_count, 1)
        PrintMessage("  Route A: Processed")
    }
}

SubRoutine.RouteBHandler {
    PrintMessage("  Route B: Checking")
    ReceiveMessage.RouteB {
        route_b_count = Add(route_b_count, 1)
        PrintMessage("  Route B: Processed")
    }
}

SubRoutine.RouteCHandler {
    PrintMessage("  Route C: Checking")
    ReceiveMessage.RouteC {
        route_c_count = Add(route_c_count, 1)
        PrintMessage("  Route C: Processed")
    }
}

RunTask(MessageRouter)
RunTask(RouteAHandler)
RunTask(RouteBHandler)
RunTask(RouteCHandler)

// Test 2.1: Correct route chosen (7 % 3 = 1, so Route B)
test_name = "Route B received"
expected = 1
actual = route_b_count
RunTask(TestResult)

// Test 2.2: Other routes empty
test_name = "Route A empty"
expected = 0
actual = route_a_count
RunTask(TestResult)

test_name = "Route C empty"
expected = 0
actual = route_c_count
RunTask(TestResult)

// ==============================================
// SCENARIO 3: PRIORITY QUEUE WITH FORK
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 3: PRIORITY QUEUE WITH FORK")
PrintMessage("==============================================")

high_priority_done = 0
low_priority_done = 0

SubRoutine.PrioritySystem {
    PrintMessage("  Priority System: Processing request")
    
    // Send one high priority request
    SendMessage.PriorityRequest(level=>3, data=>300)
    
    // Process it
    ReceiveMessage.PriorityRequest {
        PrintMessage("  Processing priority request")
        
        // Fork to determine priority level
        Fork GreaterThan(300, 200) TrueBlock: {
            PrintMessage("  HIGH priority request")
            high_priority_done = 1
        } FalseBlock: {
            PrintMessage("  LOW priority request")
            low_priority_done = 1
        }
    }
    
    PrintMessage("  Priority System: Complete")
}

RunTask(PrioritySystem)

// Test 3.1: High priority processed
test_name = "High priority done"
expected = 1
actual = high_priority_done
RunTask(TestResult)

// Test 3.2: Low priority not processed
test_name = "Low priority not done"
expected = 0
actual = low_priority_done
RunTask(TestResult)

// ==============================================
// SCENARIO 4: STATE MACHINE WITH NESTED CONTROL
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 4: STATE MACHINE WITH NESTED CONTROL")
PrintMessage("==============================================")

machine_state = 0  // States: 0=INIT, 1=READY, 2=RUNNING, 3=DONE
transition_count = 0

SubRoutine.StateInit {
    PrintMessage("  State INIT")
    SendMessage.StateCmd(new_state=>1)
    transition_count = Add(transition_count, 1)
}

SubRoutine.StateReady {
    ReceiveMessage.StateCmd {
        machine_state = 1
        PrintMessage("  State READY")
        
        // Fork decides next transition
        Fork True TrueBlock: {
            SendMessage.StateCmd(new_state=>2)
            transition_count = Add(transition_count, 1)
        } FalseBlock: {
            PrintMessage("  ERROR: Should not reach")
        }
    }
}

SubRoutine.StateRunning {
    ReceiveMessage.StateCmd {
        machine_state = 2
        PrintMessage("  State RUNNING")
        
        SendMessage.StateCmd(new_state=>3)
        transition_count = Add(transition_count, 1)
    }
}

SubRoutine.StateDone {
    ReceiveMessage.StateCmd {
        machine_state = 3
        transition_count = Add(transition_count, 1)
        PrintMessage("  State DONE")
    }
}

RunTask(StateInit)
RunTask(StateReady)
RunTask(StateRunning)
RunTask(StateDone)

// Test 4.1: Final state
test_name = "Final state DONE"
expected = 3
actual = machine_state
RunTask(TestResult)

// Test 4.2: Transition count
test_name = "Transitions"
expected = 3
actual = transition_count
RunTask(TestResult)

// ==============================================
// SCENARIO 5: PARALLEL PIPELINES
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 5: PARALLEL PIPELINES")
PrintMessage("==============================================")

pipeline1_result = 0
pipeline2_result = 0

SubRoutine.Pipeline1Start {
    PrintMessage("  Pipeline1: Starting")
    SendMessage.Pipeline1(val=>10)
}

SubRoutine.Pipeline1Process {
    ReceiveMessage.Pipeline1 {
        PrintMessage("  Pipeline1: Processing")
        result = Multiply(10, 3)
        pipeline1_result = result
        SendMessage.Pipeline1Out(val=>result)
    }
}

SubRoutine.Pipeline1Finish {
    ReceiveMessage.Pipeline1Out {
        PrintMessage("  Pipeline1: Complete")
    }
}

SubRoutine.Pipeline2Start {
    PrintMessage("  Pipeline2: Starting")
    SendMessage.Pipeline2(val=>20)
}

SubRoutine.Pipeline2Process {
    ReceiveMessage.Pipeline2 {
        PrintMessage("  Pipeline2: Processing")
        result = Multiply(20, 3)
        pipeline2_result = result
        SendMessage.Pipeline2Out(val=>result)
    }
}

SubRoutine.Pipeline2Finish {
    ReceiveMessage.Pipeline2Out {
        PrintMessage("  Pipeline2: Complete")
    }
}

RunTask(Pipeline1Start)
RunTask(Pipeline1Process)
RunTask(Pipeline1Finish)
RunTask(Pipeline2Start)
RunTask(Pipeline2Process)
RunTask(Pipeline2Finish)

// Test 5.1: Pipeline 1 result
test_name = "Pipeline1 result"
expected = 30
actual = pipeline1_result
RunTask(TestResult)

// Test 5.2: Pipeline 2 result
test_name = "Pipeline2 result"
expected = 60
actual = pipeline2_result
RunTask(TestResult)

// ==============================================
// SCENARIO 6: FAULT TOLERANT SYSTEM
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 6: FAULT TOLERANT SYSTEM")
PrintMessage("==============================================")

attempts = 0
success = 0

SubRoutine.RetryAttempt1 {
    PrintMessage("  Attempt 1")
    attempts = 1
    SendMessage.Work(attempt=>1)
}

SubRoutine.CheckResult1 {
    ReceiveMessage.Work {
        PrintMessage("  Attempt 1 result")
        SendMessage.Failure(code=>1)
    }
}

SubRoutine.RetryAttempt2 {
    ReceiveMessage.Failure {
        PrintMessage("  Attempt 2")
        attempts = 2
        SendMessage.Work(attempt=>2)
    }
}

SubRoutine.CheckResult2 {
    ReceiveMessage.Work {
        PrintMessage("  Attempt 2 result")
        SendMessage.Failure(code=>1)
    }
}

SubRoutine.RetryAttempt3 {
    ReceiveMessage.Failure {
        PrintMessage("  Attempt 3")
        attempts = 3
        SendMessage.Work(attempt=>3)
    }
}

SubRoutine.CheckResult3 {
    ReceiveMessage.Work {
        PrintMessage("  Attempt 3 succeeded")
        success = 1
        SendMessage.Success(code=>100)
    }
}

RunTask(RetryAttempt1)
RunTask(CheckResult1)
RunTask(RetryAttempt2)
RunTask(CheckResult2)
RunTask(RetryAttempt3)
RunTask(CheckResult3)

// Test 6.1: Attempts
test_name = "Retry attempts"
expected = 3
actual = attempts
RunTask(TestResult)

// Test 6.2: Success achieved
test_name = "Eventually succeeded"
expected = 1
actual = success
RunTask(TestResult)

// ==============================================
// SCENARIO 7: COMPLEX CONDITIONAL WORKFLOW
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 7: COMPLEX CONDITIONAL WORKFLOW")
PrintMessage("==============================================")

workflow_path = 0
workflow_result = 0

SubRoutine.WorkflowEngine {
    PrintMessage("  Workflow Engine: Starting")
    
    input_value = 42
    
    // Branch on input range
    Branch 1 {
        Case 1: {
            // Complex nested logic
            Fork GreaterThan(input_value, 30) TrueBlock: {
                PrintMessage("  Path A: High value branch")
                workflow_path = 1
                
                // Nested fork
                Fork LessThan(input_value, 50) TrueBlock: {
                    workflow_result = Multiply(input_value, 2)
                    SendMessage.WorkflowDone(result=>workflow_result)
                } FalseBlock: {
                    workflow_result = Multiply(input_value, 3)
                }
            } FalseBlock: {
                PrintMessage("  Path B: Low value branch")
                workflow_path = 2
                workflow_result = Add(input_value, 10)
            }
        }
        Default: {
            workflow_path = 99
        }
    }
    
    PrintMessage("  Workflow Engine: Finished")
}

SubRoutine.WorkflowComplete {
    ReceiveMessage.WorkflowDone {
        PrintMessage("  Workflow: Result received")
    }
}

RunTask(WorkflowEngine)
RunTask(WorkflowComplete)

// Test 7.1: Correct path taken
test_name = "Workflow path"
expected = 1
actual = workflow_path
RunTask(TestResult)

// Test 7.2: Result computed
test_name = "Workflow result"
expected = 84  // 42 * 2
actual = workflow_result
RunTask(TestResult)

// ==============================================
// SCENARIO 8: PRODUCER-CONSUMER WITH SIGNALING
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("SCENARIO 8: PRODUCER-CONSUMER WITH SIGNALING")
PrintMessage("==============================================")

produced = 0
consumed = 0

SubRoutine.ProducerWithCount {
    PrintMessage("  Producer: Creating items")
    
    // Produce items using shared variable
    i = 0
    WhileLoop LessThan(i, 10) {
        produced = Add(produced, 1)
        i = Add(i, 1)
    }
    
    // Signal completion with count
    SendMessage.ProductionDone(count=>produced)
    PrintMessage("  Producer: Done, count sent")
}

SubRoutine.ConsumerWithAck {
    PrintMessage("  Consumer: Waiting for signal")
    
    ReceiveMessage.ProductionDone {
        PrintMessage("  Consumer: Got production done signal")
        
        // Consume all items
        consumed = produced
        
        SendMessage.ConsumptionDone(ack=>1)
        PrintMessage("  Consumer: Done consuming")
    }
}

SubRoutine.Coordinator {
    ReceiveMessage.ConsumptionDone {
        PrintMessage("  Coordinator: System complete")
    }
}

RunTask(ProducerWithCount)
RunTask(ConsumerWithAck)
RunTask(Coordinator)

// Test 8.1: All produced
test_name = "All produced"
expected = 10
actual = produced
RunTask(TestResult)

// Test 8.2: All consumed
test_name = "All consumed"
expected = 10
actual = consumed
RunTask(TestResult)

// ==============================================
// FINAL SUMMARY
// ==============================================
PrintMessage("")
PrintMessage("==============================================")
PrintMessage("FINAL INTEGRATION TEST SUMMARY")
PrintMessage("==============================================")

PrintMessage("Total Tests: ")
PrintNumber(total_tests)
PrintMessage("Passed: ")
PrintNumber(passed_tests)
PrintMessage("Failed: ")
PrintNumber(failed_tests)

success_rate = 0
IfCondition GreaterThan(total_tests, 0) ThenBlock: {
    success_rate = Divide(Multiply(passed_tests, 100), total_tests)
}

PrintMessage("Success Rate: ")
PrintNumber(success_rate)
PrintMessage("%")
PrintMessage("")

IfCondition EqualTo(failed_tests, 0) ThenBlock: {
    PrintMessage("ALL INTEGRATION TESTS PASSED!")
    PrintMessage("System integration VERIFIED!")
} ElseBlock: {
    PrintMessage("SOME FAILURES DETECTED")
    PrintMessage("Review failed tests above")
}

PrintMessage("")
PrintMessage("Integration Scenarios Tested:")
PrintMessage("1. Task scheduler with messages")
PrintMessage("2. Conditional routing with branches")
PrintMessage("3. Priority queue with fork")
PrintMessage("4. State machine with nested control")
PrintMessage("5. Parallel pipelines")
PrintMessage("6. Fault tolerant system with retries")
PrintMessage("7. Complex conditional workflow")
PrintMessage("8. Producer-consumer with backpressure")
PrintMessage("")
PrintMessage("All three systems working together:")
PrintMessage("- Flow Control (Fork/Branch)")
PrintMessage("- Cooperative Scheduler")
PrintMessage("- Message Passing")
PrintMessage("")
PrintMessage("Integration test complete.")
PrintMessage("==============================================")