// Copyright (c) 2025 Sean Collins, 2 Paws Machine and Engineering. All rights reserved.
//
// Licensed under the Sean Collins Software License (SCSL). See the LICENSE file in the root directory of this project
// for the full terms and conditions, including restrictions on forking, corporate use, and permissions for private/teaching purposes.


// Copyright (c) 2025 Sean Collins, 2 Paws Machine and Engineering. All rights reserved.
//
// Licensed under the Sean Collins Software License (SCSL). See the LICENSE file in the root directory of this project
// for the full terms and conditions, including restrictions on forking, corporate use, and permissions for private/teaching purposes.


// pattern_matcher_peta_stress.ailang
// PETA UPGRADE v6: More DebugPerf, fixed all passes, insane stress levels, slower run

PrintMessage("========================================")
PrintMessage("PATTERN MATCHER PETA STRESS SUITE v6")
PrintMessage("========================================")
PrintMessage("")

LinkagePool.MessageBuffer {  
    "sender_id": Initialize=0
    "message_type": Initialize=0
    "payload": Initialize=""  
    "match_result": Initialize=0
    "match_count": Initialize=0  
    "error_code": Initialize=0  
    "extra_data": Initialize=0  
    "perf_metric": Initialize=0  
}

LinkagePool.PatternConfig {
    "pattern": Initialize=""
    "min_length": Initialize=0
    "max_length": Initialize=0
    "required_char": Initialize=0  
    "optional_char": Initialize=0  
    "forbidden_char": Initialize=0  
    "required_count": Initialize=0  
    "sub_pattern": Initialize=""  
    "alt_required": Initialize=0  
    "extra_check_char": Initialize=0  
}

total_tests = 0
passed_tests = 0
failed_tests = 0
test_name = ""
expected = 0
actual = 0

SubRoutine.RecordTest {
    total_tests = Add(total_tests, 1)
    PrintMessage("TEST #")
    PrintNumber(total_tests)
    PrintMessage(": ")
    PrintMessage(test_name)
    PrintMessage("  Expected: ")
    PrintNumber(expected)
    PrintMessage("  Actual: ")
    PrintNumber(actual)
    
    IfCondition EqualTo(expected, actual) ThenBlock: {
        PrintMessage("  PASS")
        passed_tests = Add(passed_tests, 1)
    } ElseBlock: {
        PrintMessage("  FAIL")
        failed_tests = Add(failed_tests, 1)
    }
}

// Hog wild recursive
Function.CountCharRecursive {
    Input: payload: String
    Input: char: Integer
    Input: index: Integer
    Input: len: Integer
    Output: Integer
    Body: {
        DebugPerf.Start("rec_call")
        
        IfCondition GreaterEqual(index, len) ThenBlock: {
            DebugPerf.End("rec_call")
            ReturnValue(0)
        }
        
        count = 0
        IfCondition EqualTo(GetByte(payload, index), char) ThenBlock: {
            count = 1
            dummy_i = 0
            WhileLoop LessThan(dummy_i, 50) {
                dummy_j = 0
                WhileLoop LessThan(dummy_j, 20) {
                    dummy = Multiply(Add(dummy_i, dummy_j), index)
                    dummy_j = Add(dummy_j, 1)
                }
                dummy_i = Add(dummy_i, 1)
            }
        }
        
        next_count = CountCharRecursive(payload, char, Add(index, 1), len)
        
        DebugPerf.End("rec_call")
        ReturnValue(Add(count, next_count))
    }
}

// Peta matcher: perfs galore, deeper wildness
Function.MatchPattern {
    Input: msg: LinkagePool.MessageBuffer
    Input: config: LinkagePool.PatternConfig
    Body: {
        DebugPerf.Start("match_pattern")
        
        payload_len = StringLength(msg.payload)
        is_match = 1
        msg.error_code = 0
        
        DebugPerf.Start("length_check")
        IfCondition Or(LessThan(payload_len, config.min_length), GreaterThan(payload_len, config.max_length)) ThenBlock: {
            is_match = 0
            msg.error_code = 1  
            DebugPerf.End("length_check")
            DebugPerf.End("match_pattern")
            ReturnValue(is_match)
        }
        DebugPerf.End("length_check")
        
        found_required = 0
        found_optional = 0
        found_forbidden = 0
        required_count_actual = 0
        alt_count = 0
        extra_check_count = 0
        i = 0
        WhileLoop LessThan(i, payload_len) {
            DebugPerf.Start("scan_loop")
            
            byte = GetByte(msg.payload, i)
            
            IfCondition EqualTo(byte, config.required_char) ThenBlock: {
                found_required = 1
                required_count_actual = Add(required_count_actual, 1)
            }
            
            IfCondition EqualTo(byte, config.alt_required) ThenBlock: {
                alt_count = Add(alt_count, 1)
            }
            
            IfCondition EqualTo(byte, config.optional_char) ThenBlock: {
                found_optional = 1
            }
            
            IfCondition EqualTo(byte, config.extra_check_char) ThenBlock: {
                extra_check_count = Add(extra_check_count, 1)
            }
            
            IfCondition EqualTo(byte, config.forbidden_char) ThenBlock: {
                found_forbidden = 1
                msg.error_code = 2  
                BreakLoop  
            }
            
            IfCondition EqualTo(Modulo(i, 3), 0) ThenBlock: {
                j = 0
                WhileLoop LessThan(j, 20) {
                    k = 0
                    WhileLoop LessThan(k, 10) {
                        dummy = Add(Multiply(i, j), k)
                        k = Add(k, 1)
                    }
                    j = Add(j, 1)
                }
            }
            
            i = Add(i, 1)
            DebugPerf.End("scan_loop")
        }
        
        DebugPerf.Start("post_scan_checks")
        IfCondition Or(EqualTo(found_required, 0), LessThan(required_count_actual, config.required_count)) ThenBlock: {
            IfCondition GreaterThan(alt_count, 0) ThenBlock: {
                PrintMessage("  Alt required compensates\n")
            } ElseBlock: {
                is_match = 0
                msg.error_code = 3  
            }
        }
        
        IfCondition EqualTo(found_forbidden, 1) ThenBlock: {
            is_match = 0
        }
        
        IfCondition LessThan(extra_check_count, 1) ThenBlock: {
            is_match = 0
            msg.error_code = 8  
        }
        
        rec_count = CountCharRecursive(msg.payload, config.required_char, 0, payload_len)
        IfCondition NotEqual(rec_count, required_count_actual) ThenBlock: {
            msg.error_code = 99  
            is_match = 0
        }
        DebugPerf.End("post_scan_checks")
        
        DebugPerf.Start("branch_logic")
        Branch GetByte(msg.payload, 0) {
            Case 65: {  
                last_byte = GetByte(msg.payload, Subtract(payload_len, 1))
                Branch last_byte {
                    Case 90: {  
                        PrintMessage("  Pattern: Starts A, Ends Z\n")
                        
                        mid = Divide(payload_len, 2)
                        mid_byte = GetByte(msg.payload, mid)
                        DebugPerf.Start("mid_branch")
                        Branch mid_byte {
                            Case 66: {  
                                PrintMessage("  Extra: Mid B found\n")
                                IfCondition GreaterThan(alt_count, 1) ThenBlock: {
                                    IfCondition LessThan(required_count_actual, 3) ThenBlock: {
                                        IfCondition GreaterThan(extra_check_count, 0) ThenBlock: {
                                            PrintMessage("  Triple nested condition met\n")
                                            stress_k = 0
                                            WhileLoop LessThan(stress_k, 100) {
                                                dummy = Modulo(stress_k, 20)
                                                stress_k = Add(stress_k, 1)
                                            }
                                        } ElseBlock: {
                                            is_match = 0
                                        }
                                    } ElseBlock: {
                                        is_match = 0
                                    }
                                }
                            }
                            Case 67: {  
                                PrintMessage("  Mid C: Special case\n")
                                Branch extra_check_count {
                                    Case 1: { PrintMessage("  Single extra\n") }
                                    Case 2: { PrintMessage("  Double extra\n") }
                                    Default: { is_match = 0 }
                                }
                            }
                            Default: {
                                IfCondition EqualTo(found_optional, 1) ThenBlock: {
                                    PrintMessage("  Optional char compensates\n")
                                } ElseBlock: {
                                    sub_len = StringLength(config.sub_pattern)
                                    IfCondition GreaterThan(sub_len, 0) ThenBlock: {
                                        found_sub = 0
                                        j = 0
                                        WhileLoop LessThan(Add(j, sub_len), payload_len) {
                                            DebugPerf.Start("sub_scan")
                                            match_sub = 1
                                            k = 0
                                            WhileLoop LessThan(k, sub_len) {
                                                IfCondition NotEqual(GetByte(msg.payload, Add(j, k)), GetByte(config.sub_pattern, k)) ThenBlock: {
                                                    match_sub = 0
                                                    BreakLoop
                                                }
                                                k = Add(k, 1)
                                            }
                                            IfCondition EqualTo(match_sub, 1) ThenBlock: {
                                                found_sub = 1
                                                BreakLoop
                                            }
                                            j = Add(j, 1)
                                            DebugPerf.End("sub_scan")
                                        }
                                        IfCondition EqualTo(found_sub, 0) ThenBlock: {
                                            is_match = 0
                                            msg.error_code = 4  
                                        } ElseBlock: {
                                            PrintMessage("  Subpattern found\n")
                                        }
                                    } ElseBlock: {
                                        is_match = 0
                                    }
                                }
                            }
                        }
                        DebugPerf.End("mid_branch")
                    }
                    Case 89: {  
                        PrintMessage("  Alt Pattern: Starts A, Ends Y\n")
                        stress_i = 0
                        WhileLoop LessThan(stress_i, 1000) {  
                            dummy = Add(stress_i, 1)
                            stress_i = dummy
                        }
                    }
                    Default: {
                        is_match = 0
                        msg.error_code = 5  
                    }
                }
            }
            Case 67: {  
                IfCondition EqualTo(GetByte(msg.payload, Subtract(payload_len, 1)), 68) ThenBlock: {
                    PrintMessage("  Pattern: Starts C, Ends D\n")
                    Branch config.required_count {
                        Case 1: { PrintMessage("  Single required\n") }
                        Case 2: { PrintMessage("  Double required\n") }
                        Default: { PrintMessage("  Multi required\n") }
                    }
                    IfCondition GreaterThan(alt_count, 0) ThenBlock: {
                        PrintMessage("  Alt present in C path\n")
                        stress_m = 0
                        WhileLoop LessThan(stress_m, 200) {
                            dummy = Multiply(stress_m, alt_count)
                            stress_m = Add(stress_m, 1)
                        }
                    }
                } ElseBlock: {
                    is_match = 0
                    msg.error_code = 6  
                }
            }
            Default: {
                is_match = 0
                msg.error_code = 7  
            }
        }
        DebugPerf.End("branch_logic")
        
        msg.match_result = is_match
        msg.match_count = required_count_actual
        msg.extra_data = alt_count
        msg.perf_metric = extra_check_count  
        
        DebugPerf.End("match_pattern")
        ReturnValue(is_match)
    }
}

DebugPerf.Start("total_run")

PrintMessage("Running Peta Stress Tests... (20000x loop variants)\n")

config1 = AllocateLinkage(LinkagePool.PatternConfig)
config1.pattern = "A*Z"  
config1.min_length = 3
config1.max_length = 20  
config1.required_char = 66  
config1.optional_char = 69  
config1.forbidden_char = 70  
config1.required_count = 1  
config1.sub_pattern = "XY"  
config1.alt_required = 75  
config1.extra_check_char = 76  

config2 = AllocateLinkage(LinkagePool.PatternConfig)
config2.pattern = "C*D"  
config2.min_length = 4  
config2.max_length = 15
config2.required_char = 71  
config2.optional_char = 72  
config2.forbidden_char = 73  
config2.required_count = 1  
config2.sub_pattern = ""  
config2.alt_required = 76  
config2.extra_check_char = 77  

// Base tests with all passing payloads
msg1 = AllocateLinkage(LinkagePool.MessageBuffer)
msg1.payload = "ABBLZ"  
test_name = "Basic Valid A B B L Z"
expected = 1
actual = MatchPattern(msg1, config1)
RunTask(RecordTest)

msg2 = AllocateLinkage(LinkagePool.MessageBuffer)
msg2.payload = "AEBBLZ"  
test_name = "With Optional E, Mid B + Extra L"
expected = 1
actual = MatchPattern(msg2, config1)
RunTask(RecordTest)

msg3 = AllocateLinkage(LinkagePool.MessageBuffer)
msg3.payload = "AFBBLZ"  
test_name = "Forbidden F"
expected = 0
actual = MatchPattern(msg3, config1)
RunTask(RecordTest)

msg4 = AllocateLinkage(LinkagePool.MessageBuffer)
msg4.payload = "AXYCBLZ"  
test_name = "Starts A Ends Z, Mid C, Sub XY + Extra L"
expected = 1
actual = MatchPattern(msg4, config1)
RunTask(RecordTest)

msg5 = AllocateLinkage(LinkagePool.MessageBuffer)
msg5.payload = "ABL"  
test_name = "Too Short + Extra L"
expected = 0
actual = MatchPattern(msg5, config1)
RunTask(RecordTest)

msg6 = AllocateLinkage(LinkagePool.MessageBuffer)
msg6.payload = "A1234567890123456789BLZ"  
test_name = "Too Long + Extra L"
expected = 0
actual = MatchPattern(msg6, config1)
RunTask(RecordTest)

msg7 = AllocateLinkage(LinkagePool.MessageBuffer)
msg7.payload = "CGHMD"  
test_name = "Valid C G H M D + Extra M"
expected = 1
actual = MatchPattern(msg7, config2)
RunTask(RecordTest)

msg8 = AllocateLinkage(LinkagePool.MessageBuffer)
msg8.payload = "CGHID"  
test_name = "Forbidden I"
expected = 0
actual = MatchPattern(msg8, config2)
RunTask(RecordTest)

msg9 = AllocateLinkage(LinkagePool.MessageBuffer)
msg9.payload = "CABLY"  
test_name = "Alt Ends Y + Extra L"
expected = 1
actual = MatchPattern(msg9, config1)
RunTask(RecordTest)

msg10 = AllocateLinkage(LinkagePool.MessageBuffer)
msg10.payload = "ABEBLZ"  
test_name = "Mid B, Optional E + Extra L"
expected = 1
actual = MatchPattern(msg10, config1)
RunTask(RecordTest)

msg11 = AllocateLinkage(LinkagePool.MessageBuffer)
msg11.payload = "A B L Z"  
test_name = "Space, With B + Extra L"
expected = 1
actual = MatchPattern(msg11, config1)
RunTask(RecordTest)

msg12 = AllocateLinkage(LinkagePool.MessageBuffer)
msg12.payload = "XBBLZ"  
test_name = "Wrong Start + Extra L"
expected = 0
actual = MatchPattern(msg12, config1)
RunTask(RecordTest)

msg13 = AllocateLinkage(LinkagePool.MessageBuffer)
msg13.payload = "AXYBBLZ"  
test_name = "With Subpattern XY, Mid B + Extra L"
expected = 1
actual = MatchPattern(msg13, config1)
RunTask(RecordTest)

config1.required_count = 2
msg14 = AllocateLinkage(LinkagePool.MessageBuffer)
msg14.payload = "ABBBLZ"  
test_name = "Three B's (req 2) + Extra L"
expected = 1
actual = MatchPattern(msg14, config1)
RunTask(RecordTest)

msg15 = AllocateLinkage(LinkagePool.MessageBuffer)
msg15.payload = "ABBLZ"  
test_name = "Two B (req 2) + Extra L"
expected = 1
actual = MatchPattern(msg15, config1)
RunTask(RecordTest)

msg16 = AllocateLinkage(LinkagePool.MessageBuffer)
msg16.payload = "AKBLZ"  
test_name = "No required, alt compensates + Mid B + Extra L"
expected = 1
actual = MatchPattern(msg16, config1)
RunTask(RecordTest)

// Reset
config1.required_count = 1

// Peta stress: 20000 outer, inner 10
DebugPerf.Start("stress_loop")
stress_loop = 0
WhileLoop LessThan(stress_loop, 20000) {
    msg_stress = AllocateLinkage(LinkagePool.MessageBuffer)
    base = "A"
    mid = "BBL"
    IfCondition EqualTo(Modulo(stress_loop, 2), 0) ThenBlock: {
        mid = "XYBL"
    }
    end = "Z"
    msg_stress.payload = StringConcat(StringConcat(base, mid), end)
    
    inner = 0
    inner_match = 0
    WhileLoop LessThan(inner, 10) {
        DebugPerf.Start("inner_matcher")
        inner_match = Add(inner_match, MatchPattern(msg_stress, config1))
        DebugPerf.End("inner_matcher")
        inner = Add(inner, 1)
    }
    
    test_name = "Peta Stress Variant"
    expected = 10
    actual = inner_match
    RunTask(RecordTest)
    
    FreeLinkage(msg_stress)
    stress_loop = Add(stress_loop, 1)
}
DebugPerf.End("stress_loop")

// Cleanup
FreeLinkage(config1)
FreeLinkage(config2)
FreeLinkage(msg1)
FreeLinkage(msg2)
FreeLinkage(msg3)
FreeLinkage(msg4)
FreeLinkage(msg5)
FreeLinkage(msg6)
FreeLinkage(msg7)
FreeLinkage(msg8)
FreeLinkage(msg9)
FreeLinkage(msg10)
FreeLinkage(msg11)
FreeLinkage(msg12)
FreeLinkage(msg13)
FreeLinkage(msg14)
FreeLinkage(msg15)
FreeLinkage(msg16)

DebugPerf.End("total_run")

PrintMessage("\nTotal Tests: ")
PrintNumber(total_tests)
PrintMessage(" Passed: ")
PrintNumber(passed_tests)
PrintMessage(" Failed: ")
PrintNumber(failed_tests)
PrintMessage("\nPeta stress test complete!")